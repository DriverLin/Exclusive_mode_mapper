<!DOCTYPE html>
<html>


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mappertool</title>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
    <link href=https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        var dowing = false
        var dowKey
        var list = {}
        var jskmap = {
            65: "A",
            66: "B",
            67: "C",
            68: "D",
            69: "E",
            70: "F",
            71: "G",
            72: "H",
            73: "I",
            74: "J",
            75: "K",
            76: "L",
            77: "M",
            78: "N",
            79: "O",
            80: "P",
            81: "Q",
            82: "R",
            83: "S",
            84: "T",
            85: "U",
            86: "V",
            87: "W",
            88: "X",
            89: "Y",
            90: "Z",
            48: "BTN_RIGHT",
            49: "1",
            50: "2",
            51: "3",
            52: "4",
            53: "5",
            54: "6",
            55: "7",
            56: "BTN_LEFT",
            57: "BTN_MIDDLE",
            96: "NUM0",
            97: "NUM1",
            98: "NUM2",
            99: "NUM3",
            100: "NUM4",
            101: "NUM5",
            102: "NUM6",
            103: "NUM7",
            104: "NUM8",
            105: "NUM9",
            106: "*",
            107: "+",
            108: "Enter",
            109: "-",
            110: ".",
            111: "/",
            112: "F1",
            113: "F2",
            114: "F3",
            115: "F4",
            116: "F5",
            117: "F6",
            118: "F7",
            119: "F8",
            120: "F9",
            121: "F10",
            122: "F11",
            123: "F12",
            8: "BackSpace",
            27: "Esc ",
            39: "Right Arrow",
            37: "Left Arrow ",
            40: "Down Arrow",
            38: "Up Arrow",
            189: "-_",
            190: ".> ",
            32: "Spacebar",
            9: "Tab",
            33: "Page Up",
            34: "Page Down",
            13: "Enter",
            45: "Insert",
            186: ";:",
            46: "Delete",
            192: "`~",
            191: " /?",
            144: "Num Lock",
            17: "Control",
            36: "Home",
            35: "End",
            16: "Shift",
            219: "[{",
            221: "}]",
            220: "|",
            187: "=+",
            188: ",<",
            222: "'",
            20: "Cape Lock",
            18: "Alt",
        }
        var linuxKmap = {
            "A": 30,
            "B": 48,
            "C": 46,
            "D": 32,
            "E": 18,
            "F": 33,
            "G": 34,
            "H": 35,
            "I": 23,
            "J": 36,
            "K": 37,
            "L": 38,
            "M": 50,
            "N": 49,
            "O": 24,
            "P": 25,
            "Q": 16,
            "R": 19,
            "S": 31,
            "T": 20,
            "U": 22,
            "V": 47,
            "W": 17,
            "X": 45,
            "Y": 21,
            "Z": 44,
            "0": 11,
            "1": 2,
            "2": 3,
            "3": 4,
            "4": 5,
            "5": 6,
            "6": 7,
            "7": 8,
            "8": 9,
            "9": 10,
            "NUM0": 82,
            "NUM1": 79,
            "NUM2": 80,
            "NUM3": 81,
            "NUM4": 75,
            "NUM5": 76,
            "NUM6": 77,
            "NUM7": 71,
            "NUM8": 72,
            "NUM9": 73,
            "*": 55,
            "+": 78,
            "Enter": 96,
            "-": 12,
            ".": 52,
            "/": 98,
            "F1": 59,
            "F2": 60,
            "F3": 61,
            "F4": 62,
            "F5": 63,
            "F6": 64,
            "F7": 65,
            "F8": 66,
            "F9": 67,
            "F10": 68,
            "F11": 87,
            "F12": 88,
            "BackSpace": 14,
            "Esc ": 1,
            "Right Arrow": 106,
            "Left Arrow ": 105,
            "Down Arrow": 108,
            "Up Arrow": 103,
            "-_": 12,
            ".> ": 52,
            "Spacebar": 57,
            "Tab": 15,
            "Page Up": 104,
            "Page Down": 109,
            "Enter": 28,
            "Insert": 110,
            ";:": 39,
            "Delete": 111,
            "`~": 74,
            " /?": 53,
            "Num Lock": 69,
            "Control": 29,
            "Home": 102,
            "End": 107,
            "Shift": 42,
            "[{": 26,
            "}]": 27,
            "|": 43,
            "=+": 13,
            ",<": 51,
            "'": 40,
            "Cape Lock": 58,
            "Alt": 56,
            "BTN_MOUSE": 256,//额外的
            "BTN_LEFT": 256,
            "BTN_RIGHT": 257,
            "BTN_MIDDLE": 258,
            "BTN_SIDE": 259,
            "BTN_EXTRA": 260,
            "BTN_FORWARD": 261,
            "BTN_BACK": 262,
            "BTN_TASK": 263
        }

        function getNaturalWidth(img) {
            var image = new Image()
            image.src = img.src
            var naturalWidth = image.width
            return naturalWidth
        }
        function getNaturalHeight(img) {
            var image = new Image()
            image.src = img.src
            var naturalWidth = image.height
            return naturalWidth
        }
        function getMapper() {
            var text = ""
            const target = document.getElementById('img')
            var Y = getNaturalWidth(target)
            var X = getNaturalHeight(target)
            console.log(Y, X)
            var kw = list[87]//确定长度
            var ks = list[83]//确定原点
            var relative = 300
            if (kw != undefined && ks != undefined) {
                relative = Math.sqrt(Math.pow(kw.x * X - ks.x * X, 2) + Math.pow(kw.y * Y - ks.y * Y, 2))
            }
            var wheel_start_x = 600;
            var wheely_start_y = 600;
            if (ks != undefined) {
                wheel_start_x = (1 - ks.y) * X
                wheely_start_y = ks.x * Y
            }
            if (relative > wheel_start_x) {
                relative = wheel_start_x - 10
            }
            console.log("x:" + parseInt(wheel_start_x), "   y:" + parseInt(wheely_start_y), "   len:" + parseInt(relative))
            text += parseInt(X / 2) + " " + parseInt(Y / 2 + 200) + " 1\n"
            var wheelNumCount = 0;
            for (var posY of [parseInt(wheely_start_y - relative), parseInt(wheely_start_y), parseInt(wheely_start_y + relative)]) {
                for (var posX of [parseInt(wheel_start_x - relative), parseInt(wheel_start_x), parseInt(wheel_start_x + relative)]) {
                    text += wheelNumCount + " " + posX + " " + posY + "\n";
                    wheelNumCount++
                }
            }

            for (var k in list) {
                var kname = jskmap[k];//JScode获取名称
                var py = parseInt(list[k].x * Y);
                var px = parseInt((1 - list[k].y) * X);//换到Linux

                if (kname == "W" || kname == "A" || kname == "S" || kname == "D") {//ws用来确定左摇杆了
                    console.log("pass\n");
                }
                else if (kname in linuxKmap) {
                    text += linuxKmap[kname] + " " + px + " " + py + "\n"
                }
            }
            console.log(text)
            console.log(list)
            $('body').append(`<textarea type="text" id="copy"></input>`)
            document.getElementById('copy').value = text;
            $('#copy').select(); // 选择对象
            document.execCommand("Copy"); // 执行浏览器复制命令
            $('#copy').remove();
        }
        document.onclick = function (event) {

            if (dowing) {
                const target = document.getElementById('img')
                var x = event.offsetX / target.offsetWidth
                var y = event.offsetY / target.offsetHeight
                console.log(dowKey)
                console.log(x, y)
                var km = {
                    'key': jskmap[dowKey],
                    'x': x,
                    'y': y
                }
                list[dowKey] = km;
                $('.mask').empty()
                var Arrary = []
                for (var key in list) {
                    var value = list[key];
                    Arrary.push(value)
                    $('.mask').append(`
                <button class="button" style="top:${target.offsetHeight * value.y - 16}px;left:${target.offsetWidth * value.x - 16}px;">${value.key}</button>
                `)
                }
                getMapper()
                return false;
            }
        }
        document.onkeydown = function (event) {
            dowing = true
            dowKey = event.keyCode
            return false;
        }
        document.onkeyup = function (event) {
            dowing = false
        }
        document.oncontextmenu = function (e) {
            e.preventDefault();
        };

        function changepic() {
            var reads = new FileReader();
            f = document.getElementById('fileInput').files[0];
            reads.readAsDataURL(f);
            reads.onload = function (e) {
                document.getElementById('img').src = this.result;
            };
            document.getElementById('mainContainer').hidden = false;
            document.getElementById('uploadBtn').hidden = true;
        }
        function uploadImg() {
            document.getElementById('fileInput').click();
        }
    </script>
    <style type="text/css">
        body {
            background: #00796B;
        }

        .pic {
            height: 100%;
            width: 100%;
            left: 0px;
            top: 0px;
        }

        .pic img {
            float: left;
            width: 100%;
            left: 0px;
            top: 0px;
        }

        .mask {
            z-index: 1;
            position: absolute;
            height: 100%;
            width: 100%;
            left: 0px;
            top: 0px;
        }

        .mask button {
            height: 32px;
            width: 32px;
            border: 16px;
            border-radius: 16px;
            position: absolute;
            float: left;
            color: whitesmoke;
            background-color: #D90051;
        }

        #uploadBtn {
            position: absolute;
            width: 200px;
            height: 80px;
            left: 50%;
            margin-left: -105px;
            top: 50%;
            border-radius: 50px;
            border: 5px solid #0984e3;
            transition: .3s;
            font-size: 24px;
            background: #2C3A47;
            color: white;
            box-shadow: 0 0 5px #000;
        }

        #uploadBtn:hover {
            box-shadow: 0 0 20px #000;
            outline: none;
            width: 280px;
            margin-left: -145px;
            border: 5px solid #00b894;
        }

        #uploadBtn:focus {
            outline: none;
        }
    </style>
</head>

<body>
    <input id="fileInput" type="file" style="display:none" accept="image/*" onchange="changepic(this)"></input>
    <button id="uploadBtn" onclick="uploadImg()">上传截图</button>
    <div id="mainContainer" hidden="true">
        <div class="pic">
            <img id="img" src="">
        </div>
        <div class="mask">
        </div>
    </div>
</body>

</html>